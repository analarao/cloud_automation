# Download and install istioctl (if you don't have it)
curl -L https://istio.io/downloadIstio | sh -

# Install Istio on the cluster (use the 'demo' profile for now)
./istio-1.xx.x/bin/istioctl install --set profile=demo -y

kubectl create namespace target-services
kubectl create namespace monitoring


kubectl label namespace target-services istio-injection=enabled

# Apply the core Bookinfo services to our 'target-services' namespace
kubectl apply -f ./istio-1.xx.x/samples/bookinfo/platform/kube/bookinfo.yaml -n target-services

# Apply the gateway to allow external traffic
kubectl apply -f ./istio-1.xx.x/samples/bookinfo/networking/bookinfo-gateway.yaml -n target-services


sudo dnf install helm

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo add vector https://helm.vector.dev
helm repo add kiali https://kiali.org/helm-charts
helm repo update




helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
  --set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false


#inside info dir
helm install loki grafana/loki -n monitoring -f loki-single.yaml 

  
  # Apply the monitor config provided by Istio
  kubectl apply -f ./istio-1.28.0/samples/addons/extras/prometheus-operator.yaml
  #not this
  #kubectl apply -f ./istio-1.xx.x/samples/addons/prometheus.yaml -n monitoring 


#applying kiali config and launching
helm install kiali kiali/kiali-server \
  --namespace istio-system \
  -f kiali-values.yaml

#to upgrade kiali config
helm upgrade kiali kiali/kiali-server \
  --namespace istio-system \
  -f kiali-values.yaml

#installing vector config
helm install vector vector/vector \
  --namespace monitoring \
  -f vector-values.yaml

#upgrading vector config
helm upgrade vector vector/vector \
  -n monitoring \
  -f vector-values.yaml



#vizualization
kubectl port-forward --namespace monitoring svc/prometheus-grafana 8080:80
kubectl -n monitoring port-forward svc/loki 3100:3100


#grab grafana admin password
kubectl get secret --namespace monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode

-----ISTIO-------
#launch kiali
istioctl dashboard kiali

#for the secret for kiali login
kubectl create token kiali -n istio-system


