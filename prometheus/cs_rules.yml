# prometheus/cs_rules.yml
groups:

# === A. CS: PROACTIVE FAULT PREDICTION (Linear Exhaustion) ===
- name: predictive_resource_exhaustion
  interval: 1m
  rules:
    - record: node_memory_mem_available_prediction_seconds
      expr: predict_linear(node_memory_MemAvailable_bytes[1h], 0)
      
    - record: node_filesystem_avail_prediction_seconds
      expr: predict_linear(node_filesystem_avail_bytes{mountpoint="/"}[1h], 0)
      
- name: cs_ml_prediction_alerts
  rules:
  - alert: PredictedCpuBreach
    expr: cs_ml_predicted_cpu_user_rate > 0.01
    for: 1m
    labels:
      severity: critical
      alert_type: SLO_PREDICTION
      source: CS_ML_Service
      # Inherit target_pod, target_namespace, target_container, target_app from metric labels
    annotations:
      summary: "Predicted CPU breach for pod {{ $labels.target_pod }} in namespace {{ $labels.target_namespace }}"
      description: "The CS ML service predicts CPU usage will exceed SLO threshold (0.01) within 15 minutes. Pod: {{ $labels.target_pod }}, App: {{ $labels.target_app }}, Container: {{ $labels.target_container }}, Current predicted value: {{ $value | humanizePercentage }}"
      predicted_value: "{{ $value }}"
      threshold: "0.01"
      # Note: Topology info will be fetched by Alertmanager webhook receiver or CB service
  
# === B. CS: ANOMALY DETECTION (Statistical/Z-Score) BASES ===
- name: statistical_anomaly_baselines
  interval: 5m
  rules:
    - record: node_cpu_idle_rate_24h_avg
      expr: avg_over_time(rate(node_cpu_seconds_total{mode="idle"}[5m])[24h:5m])
      
    - record: node_cpu_idle_rate_24h_stddev
      expr: stddev_over_time(rate(node_cpu_seconds_total{mode="idle"}[5m])[24h:5m])

# === C. CS: ALERTING RULES (Triggers for CB) ===
- name: autonomous_platform_alerts
  rules:
    # 1. Alert: Memory Exhaustion Prediction
    - alert: CS_Memory_Exhaustion_Predicted
      expr: node_memory_mem_available_prediction_seconds < 21600 # < 6 hours
      for: 5m
      labels:
        severity: high
        alert_type: SLO_PREDICTION
        metric: node_memory_MemAvailable_bytes
      annotations:
        summary: "Memory exhaustion predicted on host in less than 6 hours."
        description: "The available memory is trending toward 0 on {{ $labels.instance }}. Predicted Time to Zero: {{ $value | humanizeDuration }}"
        
    # 2. Alert: Disk Space Exhaustion Prediction
    - alert: CS_Disk_Exhaustion_Predicted
      expr: node_filesystem_avail_prediction_seconds{mountpoint="/"} < 43200 # < 12 hours
      for: 15m
      labels:
        severity: warning
        alert_type: SLO_PREDICTION
        metric: node_filesystem_avail_bytes
      annotations:
        summary: "Root disk space exhaustion predicted in less than 12 hours."
        description: "File system {{ $labels.mountpoint }} on {{ $labels.instance }} is predicted to run out of space soon."

    # 3. Alert: CPU High Anomaly Detection (3-Sigma)
    - alert: CS_CPU_High_Anomaly_Detected
      expr: rate(node_cpu_seconds_total{mode="idle"}[5m]) < node_cpu_idle_rate_24h_avg - (3 * node_cpu_idle_rate_24h_stddev)
      for: 5m
      labels:
        severity: critical
        alert_type: ANOMALY_DETECTED
        metric: node_cpu_seconds_total
      annotations:
        summary: "Anomalous high CPU utilization detected."
        description: "CPU idle rate is 3-sigma below its 24-hour baseline on {{ $labels.instance }}. Likely a runaway process."